"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[45],{45:function(){let e,t;function n(e,t,n,r){return new(n||(n=Promise))(function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):((t=e.value)instanceof n?t:new n(function(e){e(t)})).then(s,a)}c((r=r.apply(e,t||[])).next())})}"function"==typeof SuppressedError&&SuppressedError;var r,i,o,s,a,c,d,l,u,y,h,p,f,v,g,m,w,I,b,k,S,E,L,C,A={exports:{}},T=A.exports,K=(p||(p=1,r=function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],i={},o=null;function s(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function c(){for(var n=this.getLevel(),i=0;i<r.length;i++){var o=r[i];this[o]=i<n?e:this.methodFactory(o,n,this.name)}if(this.log=this.debug,typeof console===t&&n<this.levels.SILENT)return"No console available for logging"}function d(e){return function(){typeof console!==t&&(c.call(this),this[e].apply(this,arguments))}}function l(r,i,o){var c;return"debug"===(c=r)&&(c="log"),typeof console!==t&&("trace"===c&&n?a:void 0!==console[c]?s(console,c):void 0!==console.log?s(console,"log"):e)||d.apply(this,arguments)}function u(e,n){var s,a,d,u=this,y="loglevel";function h(){var e;if(typeof window!==t&&y){try{e=window.localStorage[y]}catch(e){}if(typeof e===t)try{var n=window.document.cookie,r=encodeURIComponent(y),i=n.indexOf(r+"=");-1!==i&&(e=/^([^;]+)/.exec(n.slice(i+r.length+1))[1])}catch(e){}return void 0===u.levels[e]&&(e=void 0),e}}function p(e){var t=e;if("string"==typeof t&&void 0!==u.levels[t.toUpperCase()]&&(t=u.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=u.levels.SILENT)return t;throw TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?y+=":"+e:"symbol"==typeof e&&(y=void 0),u.name=e,u.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},u.methodFactory=n||l,u.getLevel=function(){return null!=d?d:null!=a?a:s},u.setLevel=function(e,n){return d=p(e),!1!==n&&function(e){var n=(r[e]||"silent").toUpperCase();if(typeof window!==t&&y){try{window.localStorage[y]=n;return}catch(e){}try{window.document.cookie=encodeURIComponent(y)+"="+n+";"}catch(e){}}}(d),c.call(u)},u.setDefaultLevel=function(e){a=p(e),h()||u.setLevel(e,!1)},u.resetLevel=function(){d=null,function(){if(typeof window!==t&&y){try{window.localStorage.removeItem(y)}catch(e){}try{window.document.cookie=encodeURIComponent(y)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}(),c.call(u)},u.enableAll=function(e){u.setLevel(u.levels.TRACE,e)},u.disableAll=function(e){u.setLevel(u.levels.SILENT,e)},u.rebuild=function(){if(o!==u&&(s=p(o.getLevel())),c.call(u),o===u)for(var e in i)i[e].rebuild()},s=p(o?o.getLevel():"WARN");var f=h();null!=f&&(d=p(f)),c.call(u)}(o=new u).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw TypeError("You must supply a name when creating a logger.");var t=i[e];return t||(t=i[e]=new u(e,o.methodFactory)),t};var y=typeof window!==t?window.log:void 0;return o.noConflict=function(){return typeof window!==t&&window.log===o&&(window.log=y),o},o.getLoggers=function(){return i},o.default=o,o},A.exports?A.exports=r():T.log=r()),A.exports);(i=f||(f={}))[i.trace=0]="trace",i[i.debug=1]="debug",i[i.info=2]="info",i[i.warn=3]="warn",i[i.error=4]="error",i[i.silent=5]="silent",(o=v||(v={})).Default="livekit",o.Room="livekit-room",o.Participant="livekit-participant",o.Track="livekit-track",o.Publication="livekit-track-publication",o.Engine="livekit-engine",o.Signal="livekit-signal",o.PCManager="livekit-pc-manager",o.PCTransport="livekit-pc-transport",o.E2EE="lk-e2ee";let _=K.getLogger("livekit");Object.values(v).map(e=>K.getLogger(e)),_.setDefaultLevel(f.info);let x=K.getLogger("lk-e2ee");var P=Object.defineProperty,R=(e,t,n)=>t in e?P(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,O=(e,t,n)=>R(e,"symbol"!=typeof t?t+"":t,n);class F{constructor(){O(this,"_locking"),O(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){let e;this._locks+=1;let t=new Promise(t=>e=()=>{this._locks-=1,t()}),n=this._locking.then(()=>e);return this._locking=this._locking.then(()=>t),n}}(s=g||(g={}))[s.WAITING=0]="WAITING",s[s.RUNNING=1]="RUNNING",s[s.COMPLETED=2]="COMPLETED";class U{constructor(){this.pendingTasks=new Map,this.taskMutex=new F,this.nextTaskIndex=0}run(e){return n(this,void 0,void 0,function*(){let t={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:g.WAITING};this.pendingTasks.set(t.id,t);let n=yield this.taskMutex.lock();try{return t.executedAt=Date.now(),t.status=g.RUNNING,yield e()}finally{t.status=g.COMPLETED,this.pendingTasks.delete(t.id),n()}})}flush(){return n(this,void 0,void 0,function*(){return this.run(()=>n(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}let N="AES-GCM",M={key:10,delta:3,audio:1,empty:0};class D extends Error{constructor(e,t){super(t||"an error has occured"),this.name="LiveKitError",this.code=e}}(a=m||(m={}))[a.NotAllowed=0]="NotAllowed",a[a.ServerUnreachable=1]="ServerUnreachable",a[a.InternalError=2]="InternalError",a[a.Cancelled=3]="Cancelled",a[a.LeaveRequest=4]="LeaveRequest",(c=w||(w={})).PermissionDenied="PermissionDenied",c.NotFound="NotFound",c.DeviceInUse="DeviceInUse",c.Other="Other",(d=w||(w={})).getFailure=function(e){if(e&&"name"in e)return"NotFoundError"===e.name||"DevicesNotFoundError"===e.name?d.NotFound:"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?d.PermissionDenied:"NotReadableError"===e.name||"TrackStartError"===e.name?d.DeviceInUse:d.Other},(l=I||(I={}))[l.InvalidKey=0]="InvalidKey",l[l.MissingKey=1]="MissingKey",l[l.InternalError=2]="InternalError";class j extends D{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:I.InternalError,n=arguments.length>2?arguments[2]:void 0;super(40,e),this.reason=t,this.participantIdentity=n}}(u=b||(b={})).SetKey="setKey",u.RatchetRequest="ratchetRequest",u.KeyRatcheted="keyRatcheted",(k||(k={})).KeyRatcheted="keyRatcheted",(y=S||(S={})).ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",y.EncryptionError="encryptionError",(E||(E={})).Error="cryptorError";var B={exports:{}},q=function(){if(L)return B.exports;L=1;var e,t="object"==typeof Reflect?Reflect:null,n=t&&"function"==typeof t.apply?t.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};e=t&&"function"==typeof t.ownKeys?t.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var r=Number.isNaN||function(e){return e!=e};function i(){i.init.call(this)}B.exports=i,B.exports.once=function(e,t){return new Promise(function(n,r){var i;function o(n){e.removeListener(t,s),r(n)}function s(){"function"==typeof e.removeListener&&e.removeListener("error",o),n([].slice.call(arguments))}p(e,t,s,{once:!0}),"error"!==t&&(i={once:!0},"function"==typeof e.on&&p(e,"error",o,i))})},i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var o=10;function s(e){if("function"!=typeof e)throw TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function a(e){return void 0===e._maxListeners?i.defaultMaxListeners:e._maxListeners}function c(e,t,n,r){if(s(n),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),c=o[t]),void 0===c)c=o[t]=n,++e._eventsCount;else if("function"==typeof c?c=o[t]=r?[n,c]:[c,n]:r?c.unshift(n):c.push(n),(i=a(e))>0&&c.length>i&&!c.warned){c.warned=!0;var i,o,c,d=Error("Possible EventEmitter memory leak detected. "+c.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=e,d.type=t,d.count=c.length,console&&console.warn&&console.warn(d)}return e}function d(){if(!this.fired)return(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0==arguments.length)?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function l(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=d.bind(r);return i.listener=n,r.wrapFn=i,i}function u(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):h(i,i.length)}function y(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function h(e,t){for(var n=Array(t),r=0;r<t;++r)n[r]=e[r];return n}function p(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else if("function"==typeof e.addEventListener)e.addEventListener(t,function i(o){r.once&&e.removeEventListener(t,i),n(o)});else throw TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}return Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(e){if("number"!=typeof e||e<0||r(e))throw RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");o=e}}),i.init=function(){(void 0===this._events||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||r(e))throw RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},i.prototype.getMaxListeners=function(){return a(this)},i.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var i="error"===e,o=this._events;if(void 0!==o)i=i&&void 0===o.error;else if(!i)return!1;if(i){if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var s,a=Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var c=o[e];if(void 0===c)return!1;if("function"==typeof c)n(c,this,t);else for(var d=c.length,l=h(c,d),r=0;r<d;++r)n(l[r],this,t);return!0},i.prototype.addListener=function(e,t){return c(this,e,t,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(e,t){return c(this,e,t,!0)},i.prototype.once=function(e,t){return s(t),this.on(e,l(this,e,t)),this},i.prototype.prependOnceListener=function(e,t){return s(t),this.prependListener(e,l(this,e,t)),this},i.prototype.removeListener=function(e,t){var n,r,i,o,a;if(s(t),void 0===(r=this._events)||void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){a=n[o].listener,i=o;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,a||t)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0==arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0==arguments.length){var i,o=Object.keys(n);for(r=0;r<o.length;++r)"removeListener"!==(i=o[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},i.prototype.listeners=function(e){return u(this,e,!0)},i.prototype.rawListeners=function(e){return u(this,e,!1)},i.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):y.call(e,t)},i.prototype.listenerCount=y,i.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]},B.exports}();function G(e,t){let n=new TextEncoder().encode(t);switch(e){case"HKDF":return{name:"HKDF",salt:n,hash:"SHA-256",info:new ArrayBuffer(128)};case"PBKDF2":return{name:"PBKDF2",salt:n,hash:"SHA-256",iterations:1e5};default:throw Error("algorithm ".concat(e," is currently unsupported"))}}function z(e,t){return n(this,void 0,void 0,function*(){let n=G(e.algorithm.name,t),r=yield crypto.subtle.deriveKey(n,e,{name:N,length:128},!1,["encrypt","decrypt"]);return{material:e,encryptionKey:r}})}class W{constructor(){this.consecutiveSifCount=0,this.lastSifReceivedAt=0,this.userFramesSinceSif=0}recordSif(){var e;this.consecutiveSifCount+=1,null!==(e=this.sifSequenceStartedAt)&&void 0!==e||(this.sifSequenceStartedAt=Date.now()),this.lastSifReceivedAt=Date.now()}recordUserFrame(){void 0!==this.sifSequenceStartedAt&&(this.userFramesSinceSif+=1,(this.userFramesSinceSif>this.consecutiveSifCount||Date.now()-this.lastSifReceivedAt>2e3)&&this.reset())}isSifAllowed(){return this.consecutiveSifCount<100&&(void 0===this.sifSequenceStartedAt||Date.now()-this.sifSequenceStartedAt<2e3)}reset(){this.userFramesSinceSif=0,this.consecutiveSifCount=0,this.sifSequenceStartedAt=void 0}}let X=new Map;class H extends q.EventEmitter{encodeFunction(e,t){throw Error("not implemented for subclass")}decodeFunction(e,t){throw Error("not implemented for subclass")}}class V extends H{constructor(e){var t;super(),this.sendCounts=new Map,this.keys=e.keys,this.participantIdentity=e.participantIdentity,this.rtpMap=new Map,this.keyProviderOptions=e.keyProviderOptions,this.sifTrailer=null!==(t=e.sifTrailer)&&void 0!==t?t:Uint8Array.from([]),this.sifGuard=new W}get logContext(){return{participant:this.participantIdentity,mediaTrackId:this.trackId,fallbackCodec:this.videoCodec}}setParticipant(e,t){x.debug("setting new participant on cryptor",Object.assign(Object.assign({},this.logContext),{participant:e})),this.participantIdentity&&x.error("cryptor has already a participant set, participant should have been unset before",Object.assign({},this.logContext)),this.participantIdentity=e,this.keys=t,this.sifGuard.reset()}unsetParticipant(){x.debug("unsetting participant",this.logContext),this.participantIdentity=void 0}isEnabled(){return this.participantIdentity?X.get(this.participantIdentity):void 0}getParticipantIdentity(){return this.participantIdentity}getTrackId(){return this.trackId}setVideoCodec(e){this.videoCodec=e}setRtpMap(e){this.rtpMap=e}setupTransform(e,t,n,r,i){i&&(x.info("setting codec on cryptor to",{codec:i}),this.videoCodec=i),x.debug("Setting up frame cryptor transform",Object.assign({operation:e,passedTrackId:r,codec:i},this.logContext));let o=new TransformStream({transform:("encode"===e?this.encodeFunction:this.decodeFunction).bind(this)});t.pipeThrough(o).pipeTo(n).catch(e=>{x.warn(e),this.emit(E.Error,e instanceof j?e:new j(e.message,void 0,this.participantIdentity))}),this.trackId=r}setSifTrailer(e){x.debug("setting SIF trailer",Object.assign(Object.assign({},this.logContext),{trailer:e})),this.sifTrailer=e}encodeFunction(e,t){return n(this,void 0,void 0,function*(){var n;if(!this.isEnabled()||0===e.data.byteLength)return t.enqueue(e);let r=this.keys.getKeySet();if(!r){this.emit(E.Error,new j("key set not found for ".concat(this.participantIdentity," at index ").concat(this.keys.getCurrentKeyIndex()),I.MissingKey,this.participantIdentity));return}let{encryptionKey:i}=r,o=this.keys.getCurrentKeyIndex();if(i){let r=this.makeIV(null!==(n=e.getMetadata().synchronizationSource)&&void 0!==n?n:-1,e.timestamp),a=this.getUnencryptedBytes(e),c=new Uint8Array(e.data,0,a.unencryptedBytes),d=new Uint8Array(2);d[0]=12,d[1]=o;try{let n=yield crypto.subtle.encrypt({name:N,iv:r,additionalData:new Uint8Array(e.data,0,c.byteLength)},i,new Uint8Array(e.data,a.unencryptedBytes)),o=new Uint8Array(n.byteLength+r.byteLength+d.byteLength);o.set(new Uint8Array(n)),o.set(new Uint8Array(r),n.byteLength),o.set(d,n.byteLength+r.byteLength),a.isH264&&(o=function(e){let t=[];for(var n=0,r=0;r<e.length;++r){var i=e[r];i<=3&&n>=2&&(t.push(3),n=0),t.push(i),0==i?++n:n=0}return new Uint8Array(t)}(o));var s=new Uint8Array(c.byteLength+o.byteLength);return s.set(c),s.set(o,c.byteLength),e.data=s.buffer,t.enqueue(e)}catch(e){x.error(e)}}else x.debug("failed to encrypt, emitting error",this.logContext),this.emit(E.Error,new j("encryption key missing for encoding",I.MissingKey,this.participantIdentity))})}decodeFunction(e,t){return n(this,void 0,void 0,function*(){if(!this.isEnabled()||0===e.data.byteLength)return x.debug("skipping empty frame",this.logContext),this.sifGuard.recordUserFrame(),t.enqueue(e);if(function(e,t){if(0===t.byteLength)return!1;let n=new Uint8Array(e.slice(e.byteLength-t.byteLength));return t.every((e,t)=>e===n[t])}(e.data,this.sifTrailer))return(x.debug("enqueue SIF",this.logContext),this.sifGuard.recordSif(),this.sifGuard.isSifAllowed())?(e.data=e.data.slice(0,e.data.byteLength-this.sifTrailer.byteLength),t.enqueue(e)):void x.warn("SIF limit reached, dropping frame");this.sifGuard.recordUserFrame();let n=new Uint8Array(e.data)[e.data.byteLength-1];if(!this.keys.hasInvalidKeyAtIndex(n)){if(this.keys.getKeySet(n))try{let r=yield this.decryptFrame(e,n);if(this.keys.decryptionSuccess(n),r)return t.enqueue(r)}catch(e){e instanceof j&&e.reason===I.InvalidKey?this.keys.hasValidKey&&(this.emit(E.Error,e),this.keys.decryptionFailure(n)):x.warn("decoding frame failed",{error:e})}else x.warn("skipping decryption due to missing key at index ".concat(n)),this.emit(E.Error,new j("missing key at index ".concat(n," for participant ").concat(this.participantIdentity),I.MissingKey,this.participantIdentity)),this.keys.decryptionFailure(n)}})}decryptFrame(e,t){return n(this,arguments,void 0,function(e,t){var n=this;let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{ratchetCount:0};return function*(){var o;let s=n.keys.getKeySet(t);if(!i.encryptionKey&&!s)throw TypeError("no encryption key found for decryption of ".concat(n.participantIdentity));let a=n.getUnencryptedBytes(e);try{let t=new Uint8Array(e.data,0,a.unencryptedBytes);var c=new Uint8Array(e.data,t.length,e.data.byteLength-t.length);if(a.isH264&&function(e){for(var t=0;t<e.length-3;t++)if(0==e[t]&&0==e[t+1]&&3==e[t+2])return!0;return!1}(c)){c=function(e){let t=[];for(var n=e.length,r=0;r<e.length;)!(n-r>=3)||e[r]||e[r+1]||3!=e[r+2]?t.push(e[r++]):(t.push(e[r++]),t.push(e[r++]),r++);return new Uint8Array(t)}(c);let n=new Uint8Array(t.byteLength+c.byteLength);n.set(t),n.set(c,t.byteLength),e.data=n.buffer}let n=new Uint8Array(e.data,e.data.byteLength-2,2),r=n[0],d=new Uint8Array(e.data,e.data.byteLength-r-n.byteLength,r),l=t.byteLength,u=e.data.byteLength-(t.byteLength+r+n.byteLength),y=yield crypto.subtle.decrypt({name:N,iv:d,additionalData:new Uint8Array(e.data,0,t.byteLength)},null!==(o=i.encryptionKey)&&void 0!==o?o:s.encryptionKey,new Uint8Array(e.data,l,u)),h=new ArrayBuffer(t.byteLength+y.byteLength),p=new Uint8Array(h);return p.set(new Uint8Array(e.data,0,t.byteLength)),p.set(new Uint8Array(y),t.byteLength),e.data=h,e}catch(o){if(n.keyProviderOptions.ratchetWindowSize>0){if(i.ratchetCount<n.keyProviderOptions.ratchetWindowSize){let o;if(x.debug("ratcheting key attempt ".concat(i.ratchetCount," of ").concat(n.keyProviderOptions.ratchetWindowSize,", for kind ").concat(e instanceof RTCEncodedAudioFrame?"audio":"video")),(null!=r?r:s)===n.keys.getKeySet(t)){let e=yield n.keys.ratchetKey(t,!1);o=yield z(e,n.keyProviderOptions.ratchetSalt)}let a=yield n.decryptFrame(e,t,r||s,{ratchetCount:i.ratchetCount+1,encryptionKey:null==o?void 0:o.encryptionKey});return a&&o&&(null!=r?r:s)===n.keys.getKeySet(t)&&(n.keys.setKeySet(o,t,!0),n.keys.setCurrentKeyIndex(t)),a}throw x.warn("maximum ratchet attempts exceeded"),new j("valid key missing for participant ".concat(n.participantIdentity),I.InvalidKey,n.participantIdentity)}throw new j("Decryption failed: ".concat(o.message),I.InvalidKey,n.participantIdentity)}}()})}makeIV(e,t){var n;let r=new ArrayBuffer(12),i=new DataView(r);this.sendCounts.has(e)||this.sendCounts.set(e,Math.floor(65535*Math.random()));let o=null!==(n=this.sendCounts.get(e))&&void 0!==n?n:0;return i.setUint32(0,e),i.setUint32(4,t),i.setUint32(8,t-o%65535),this.sendCounts.set(e,o+1),r}getUnencryptedBytes(e){var t,n={unencryptedBytes:0,isH264:!1};if(!("type"in e))return n.unencryptedBytes=M.audio,n;{let r=null!==(t=this.getVideoCodec(e))&&void 0!==t?t:this.videoCodec;if(r!==this.detectedCodec&&(x.debug("detected different codec",Object.assign({detectedCodec:r,oldCodec:this.detectedCodec},this.logContext)),this.detectedCodec=r),"av1"===r)throw Error("".concat(r," is not yet supported for end to end encryption"));if("vp8"===r)n.unencryptedBytes=M[e.type];else if("vp9"===r)return n.unencryptedBytes=0,n;let i=new Uint8Array(e.data);try{let e=function(e){let t=[],n=0,r=0,i=e.length-2;for(;r<i;){for(;r<i&&!(0===e[r]&&0===e[r+1]&&1===e[r+2]);)r++;r>=i&&(r=e.length);let o=r;for(;o>n&&0===e[o-1];)o--;if(0===n){if(o!==n)throw TypeError("byte stream contains leading data")}else t.push(n);n=r+=3}return t}(i);if(n.isH264="h264"===r||e.some(e=>[C.SLICE_IDR,C.SLICE_NON_IDR].includes(i[e]&Y)),n.isH264){for(let t of e)switch(i[t]&Y){case C.SLICE_IDR:case C.SLICE_NON_IDR:return n.unencryptedBytes=t+2,n}throw TypeError("Could not find NALU")}}catch(e){}return n.unencryptedBytes=M[e.type],n}}getVideoCodec(e){if(0===this.rtpMap.size)return;let t=e.getMetadata().payloadType;return t?this.rtpMap.get(t):void 0}}let Y=31;(h=C||(C={}))[h.SLICE_NON_IDR=1]="SLICE_NON_IDR",h[h.SLICE_PARTITION_A=2]="SLICE_PARTITION_A",h[h.SLICE_PARTITION_B=3]="SLICE_PARTITION_B",h[h.SLICE_PARTITION_C=4]="SLICE_PARTITION_C",h[h.SLICE_IDR=5]="SLICE_IDR",h[h.SEI=6]="SEI",h[h.SPS=7]="SPS",h[h.PPS=8]="PPS",h[h.AUD=9]="AUD",h[h.END_SEQ=10]="END_SEQ",h[h.END_STREAM=11]="END_STREAM",h[h.FILLER_DATA=12]="FILLER_DATA",h[h.SPS_EXT=13]="SPS_EXT",h[h.PREFIX_NALU=14]="PREFIX_NALU",h[h.SUBSET_SPS=15]="SUBSET_SPS",h[h.DPS=16]="DPS",h[h.SLICE_AUX=19]="SLICE_AUX",h[h.SLICE_EXT=20]="SLICE_EXT",h[h.SLICE_LAYER_EXT=21]="SLICE_LAYER_EXT";class Q extends q.EventEmitter{get hasValidKey(){return!this.hasInvalidKeyAtIndex(this.currentKeyIndex)}constructor(e,t){if(super(),this.currentKeyIndex=0,t.keyringSize<1||t.keyringSize>256)throw TypeError("Keyring size needs to be between 1 and 256");this.cryptoKeyRing=Array(t.keyringSize).fill(void 0),this.decryptionFailureCounts=Array(t.keyringSize).fill(0),this.keyProviderOptions=t,this.ratchetPromiseMap=new Map,this.participantIdentity=e}hasInvalidKeyAtIndex(e){return this.keyProviderOptions.failureTolerance>=0&&this.decryptionFailureCounts[e]>this.keyProviderOptions.failureTolerance}decryptionFailure(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.currentKeyIndex;!(this.keyProviderOptions.failureTolerance<0)&&(this.decryptionFailureCounts[e]+=1,this.decryptionFailureCounts[e]>this.keyProviderOptions.failureTolerance&&x.warn("key for ".concat(this.participantIdentity," at index ").concat(e," is being marked as invalid")))}decryptionSuccess(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.currentKeyIndex;this.resetKeyStatus(e)}resetKeyStatus(e){void 0===e?this.decryptionFailureCounts.fill(0):this.decryptionFailureCounts[e]=0}ratchetKey(e){let t=!(arguments.length>1)||void 0===arguments[1]||arguments[1],r=null!=e?e:this.getCurrentKeyIndex(),i=this.ratchetPromiseMap.get(r);if(void 0!==i)return i;let o=new Promise((e,i)=>n(this,void 0,void 0,function*(){try{let i=this.getKeySet(r);if(!i)throw TypeError("Cannot ratchet key without a valid keyset of participant ".concat(this.participantIdentity));let o=i.material,s=yield function(e){return n(this,arguments,void 0,function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{name:N},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"encrypt";return function*(){return crypto.subtle.importKey("raw",e,t,!1,"derive"===n?["deriveBits","deriveKey"]:["encrypt","decrypt"])}()})}((yield function(e,t){return n(this,void 0,void 0,function*(){let n=G(e.algorithm.name,t);return crypto.subtle.deriveBits(n,e,256)})}(o,this.keyProviderOptions.ratchetSalt)),o.algorithm.name,"derive");t&&(yield this.setKeyFromMaterial(s,r,!0),this.emit(k.KeyRatcheted,s,this.participantIdentity,r)),e(s)}catch(e){i(e)}finally{this.ratchetPromiseMap.delete(r)}}));return this.ratchetPromiseMap.set(r,o),o}setKey(e){return n(this,arguments,void 0,function(e){var t=this;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return function*(){yield t.setKeyFromMaterial(e,n),t.resetKeyStatus(n)}()})}setKeyFromMaterial(e,t){return n(this,arguments,void 0,function(e,t){var n=this;let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return function*(){let i=yield z(e,n.keyProviderOptions.ratchetSalt),o=t>=0?t%n.cryptoKeyRing.length:n.currentKeyIndex;x.debug("setting new key with index ".concat(t),{usage:e.usages,algorithm:e.algorithm,ratchetSalt:n.keyProviderOptions.ratchetSalt}),n.setKeySet(i,o,r),o>=0&&(n.currentKeyIndex=o)}()})}setKeySet(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.cryptoKeyRing[t%this.cryptoKeyRing.length]=e,n&&this.emit(k.KeyRatcheted,e.material,this.participantIdentity,t)}setCurrentKeyIndex(e){return n(this,void 0,void 0,function*(){this.currentKeyIndex=e%this.cryptoKeyRing.length,this.resetKeyStatus(e)})}getCurrentKeyIndex(){return this.currentKeyIndex}getKeySet(e){return this.cryptoKeyRing[null!=e?e:this.currentKeyIndex]}}let J=[],Z=new Map,$=new U,ee=!1,et={sharedKey:!1,ratchetSalt:"LKFrameEncryptionKey",ratchetWindowSize:8,failureTolerance:10,keyringSize:16},en=new Map;function er(e,n){let r=J.filter(e=>e.getTrackId()===n);if(r.length>1){let t=r.map(e=>({participant:e.getParticipantIdentity()})).join(",");x.error("Found multiple cryptors for the same trackID ".concat(n,". target participant: ").concat(e," "),{participants:t})}let i=r[0];if(i)e!==i.getParticipantIdentity()&&i.setParticipant(e,ei(e));else{if(x.info("creating new cryptor for",{participantIdentity:e}),!et)throw Error("Missing keyProvider options");(i=new V({participantIdentity:e,keys:ei(e),keyProviderOptions:et,sifTrailer:t})).setRtpMap(en),function(e){e.on(E.Error,e=>{postMessage({kind:"error",data:{error:Error("".concat(I[e.reason],": ").concat(e.message))}})})}(i),J.push(i)}return i}function ei(e){if(ee)return eo();let t=Z.get(e);return t||((t=new Q(e,et)).on(k.KeyRatcheted,es),Z.set(e,t)),t}function eo(){return e||(x.debug("creating new shared key handler"),e=new Q("shared-key",et)),e}function es(e,t,n){postMessage({kind:"ratchetKey",data:{participantIdentity:t,keyIndex:n,material:e}})}x.setDefaultLevel("info"),onmessage=e=>{$.run(()=>n(void 0,void 0,void 0,function*(){var r,i,o;let{kind:s,data:a}=e.data;switch(s){case"init":x.setLevel(a.loglevel),x.info("worker initialized"),et=a.keyProviderOptions,ee=!!a.keyProviderOptions.sharedKey,postMessage({kind:"initAck",data:{enabled:!1}});break;case"enable":r=a.enabled,i=a.participantIdentity,x.debug("setting encryption enabled for all tracks of ".concat(i),{enable:r}),X.set(i,r),x.info("updated e2ee enabled status for ".concat(a.participantIdentity," to ").concat(a.enabled)),postMessage(e.data);break;case"decode":case"encode":er(a.participantIdentity,a.trackId).setupTransform(s,a.readableStream,a.writableStream,a.trackId,a.codec);break;case"setKey":ee?yield function(e,t){return n(this,void 0,void 0,function*(){x.info("set shared key",{index:t}),yield eo().setKey(e,t)})}(a.key,a.keyIndex):a.participantIdentity?(x.info("set participant sender key ".concat(a.participantIdentity," index ").concat(a.keyIndex)),yield ei(a.participantIdentity).setKey(a.key,a.keyIndex)):x.error("no participant Id was provided and shared key usage is disabled");break;case"removeTransform":(function(e,t){let n=J.filter(n=>n.getParticipantIdentity()===t&&n.getTrackId()===e);n.length>1&&x.error("Found multiple cryptors for the same participant and trackID combination",{trackId:e,participantIdentity:t});let r=n[0];r?r.unsetParticipant():x.warn("Could not unset participant on cryptor",{trackId:e,participantIdentity:t})})(a.trackId,a.participantIdentity);break;case"updateCodec":er(a.participantIdentity,a.trackId).setVideoCodec(a.codec);break;case"setRTPMap":en=a.map,J.forEach(e=>{e.getParticipantIdentity()===a.participantIdentity&&e.setRtpMap(a.map)});break;case"ratchetRequest":(function(e){n(this,void 0,void 0,function*(){if(ee){let t=eo();yield t.ratchetKey(e.keyIndex),t.resetKeyStatus()}else if(e.participantIdentity){let t=ei(e.participantIdentity);yield t.ratchetKey(e.keyIndex),t.resetKeyStatus()}else x.error("no participant Id was provided for ratchet request and shared key usage is disabled")})})(a);break;case"setSifTrailer":t=o=a.trailer,J.forEach(e=>{e.setSifTrailer(o)})}}))},self.RTCTransformEvent&&(x.debug("setup transform event"),self.onrtctransform=e=>{let t=e.transformer;x.debug("transformer",t),t.handled=!0;let{kind:n,participantIdentity:r,trackId:i,codec:o}=t.options,s=er(r,i);x.debug("transform",{codec:o}),s.setupTransform(n,t.readable,t.writable,i,o)})}}]);
//# sourceMappingURL=45.6ef653c04d04cee9.js.map